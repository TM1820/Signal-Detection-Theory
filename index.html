<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Working Memory Experiment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #006989 0%, #eaebed 50%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;

        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            
        }
        
        h1 {
            color: #3c0443;
            margin-bottom: 20px;
            text-align: center;
        }
        
        h2 {
            color: #006989;
            margin-bottom: 15px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }
        
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #006989);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .grid-container {
            display: grid;
            gap: 15px;
            margin: 40px 0;
            justify-content: center;
        }
        
        .grid-2 { grid-template-columns: repYeat(2, 100px); }
        .grid-3 { grid-template-columns: repeat(3, 100px); }
        .grid-4 { grid-template-columns: repeat(4, 100px); }
        .grid-5 { grid-template-columns: repeat(5, 100px); }
        
        .square {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }
        
        .square:hover {
            transform: scale(1.05);
            border-color: #333;
        }
        
        .instructions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            line-height: 1.6;
        }
        
        .instructions ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .trial-info {
            text-align: center;
            font-size: 20px;
            margin: 20px 0;
            color: #667eea;
            font-weight: 600;
        }
        
        .fixation {
            text-align: center;
            font-size: 80px;
            color: #333;
            margin: 100px 0;
        }
        
        .response-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }
        
        .btn-yes {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .btn-no {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }
        
        .confidence-scale {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .confidence-scale h3 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .confidence-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .confidence-buttons button {
            width: 70px;
            height: 70px;
            padding: 0;
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #006989 0%, #004d66 100%);
        }
        
        .confidence-buttons button:hover {
            transform: scale(1.1);
        }
        
        .confidence-label {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 15px;
            color: #666;
            padding: 0 20px;
            font-weight: 600;
        }
        
        .centered {
            text-align: center;
        }
        
        .thank-you {
            text-align: center;
            padding: 40px 0;
        }
        
        .thank-you h1 {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .thank-you p {
            font-size: 20px;
            color: #666;
            line-height: 1.8;
        }

        .yes {
            color: green;
        }

        .no {
            color: maroon;
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Page -->
        <div id="welcomePage" class="page active">
            <h1>Tannu's Working Memory Experiment</h1>
            <div class="instructions">
                <p style="font-size: 18px; line-height: 1.8;">
                    <h2 style="text-align: center;">Welcome!</h2>
                    <p style="text-align: justify;">In this study, you will be shown a series of colored squares 
                    and asked to remember their positions. Your task is to determine whether a highlighted square appeared 
                    in the previous display.</p>
                </p>
            </div>
            <div class="centered">
                <button onclick="showPage('participantPage')">Begin</button>
            </div>
        </div>

        <!-- Participant Details Page -->
        <div id="participantPage" class="page">
            <h1>Participant Information</h1>
            <div class="form-group">
                <label for="participantId">Participant :</label>
                <input type="text" id="participantId" required>
            </div>
            <div class="form-group">
                <label for="age">Age:</label>
                <input type="number" id="age" min="18" max="100" required>
            </div>
            <div class="centered">
                <button onclick="saveParticipantInfo()">Continue</button>
            </div>
        </div>

        <!-- Instructions Page -->
        <div id="instructionsPage" class="page">
            <h1>Instructions</h1>
            <div class="instructions">
                <h2>How the experiment works:</h2>
                <ul>
                    <li>You will see a grid of colored squares appear briefly on the screen</li>
                    <li>Try to remember the colors and positions of all squares</li>
                    <li>After a short delay, one square will be highlighted</li>
                    <li>Your task: <b>Decide if this highlighted square appeared in the same position in the previous display</b></li>
                    <li>Click <b><span class="yes">"YES"</span></b> if the square WAS in that position</li>
                    <li>Click <b><span class="no">"NO"</span></b> if the square was NOT in that position</li>
                    <li>After each response, rate your confidence from 1 (not confident) to 5 (very confident)</li>
                </ul>
                <h2 style="margin-top: 20px;">Important:</h2>
                <ul>
                    <li>The experiment consists of 5 sets (each with 20 trials) with increasing difficulty</li>
                    <li><b>Try to be as accurate as possible</b></li>
                    <li>Respond as quickly as you can while maintaining accuracy</li>
                </ul>
            </div>
            <div class="centered">
                <button onclick="startExperiment()">Start Experiment</button>
            </div>
        </div>

        <!-- Experiment Page -->
        <div id="experimentPage" class="page">
            <div class="trial-info">
                <div id="setInfo"></div>
                <div id="trialInfo"></div>
            </div>
            <div id="stimulusArea"></div>
        </div>

        <!-- Thank You Page -->
        <div id="thankYouPage" class="page">
            <div class="thank-you">
                <h1>Thank You! ðŸŽ‰</h1>
                <p>You have completed the experiment.</p>
                <p style="margin-top: 20px;">Your data has been prepared for download.</p>
                <p style="color: #3c0443; font-family: 'Brush Script MT', cursive; font-size: 20pt;">âœ¨ Won't you be a doll and send this CSV file to the experimenter? âœ¨</p>
                <button onclick="downloadResults()" style="margin-top: 30px;">Download Results</button>
            </div>
        </div>
    </div>

    <script>
        // Experiment configuration
        const SETS = [2, 3, 4, 5, 6]; // Number of squares in each set
        const TRIALS_PER_SET = 20;
        const ENCODING_TIME = 1000; // Time to view squares (ms)
        const RETENTION_TIME = 1000; // Delay before test (ms)
        const FIXATION_TIME = 300; // Fixation cross duration (ms)
        
        // Colors for squares
        const COLORS = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', 
                        '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52D17C'];
        
        // Experiment state
        let currentSet = 0;
        let currentTrial = 0;
        let participantData = {};
        let trialResults = [];
        let currentPositions = [];
        let targetPresent = false;
        let trialStartTime = 0;
        let currentResponse = null;

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function saveParticipantInfo() {
            const id = document.getElementById('participantId').value.trim();
            const age = document.getElementById('age').value.trim();
            
            if (!id || !age) {
                alert('Please fill in all fields');
                return;
            }
            
            participantData = { id, age};
            showPage('instructionsPage');
        }

        function startExperiment() {
            currentSet = 0;
            currentTrial = 0;
            trialResults = [];
            showPage('experimentPage');
            runTrial();
        }

        function runTrial() {
            const setSize = SETS[currentSet];
            updateTrialInfo();
            
            // Show fixation
            showFixation();
            
            setTimeout(() => {
                // Show encoding stimulus
                showEncodingStimulus(setSize);
                
                setTimeout(() => {
                    // Show retention period (blank)
                    clearStimulus();
                    
                    setTimeout(() => {
                        // Show test stimulus
                        showTestStimulus(setSize);
                    }, RETENTION_TIME);
                }, ENCODING_TIME);
            }, FIXATION_TIME);
        }

        function updateTrialInfo() {
            document.getElementById('setInfo').textContent = 
                `Set ${currentSet + 1} of ${SETS.length} (${SETS[currentSet]} squares)`;
            document.getElementById('trialInfo').textContent = 
                `Trial ${currentTrial + 1} of ${TRIALS_PER_SET}`;
        }

        function showFixation() {
            const area = document.getElementById('stimulusArea');
            area.innerHTML = '<div class="fixation">+</div>';
        }

        function clearStimulus() {
            const area = document.getElementById('stimulusArea');
            area.innerHTML = '';
        }

        function showEncodingStimulus(setSize) {
            const area = document.getElementById('stimulusArea');
            const gridSize = Math.ceil(Math.sqrt(setSize)) + 1;
            
            // Generate random positions
            currentPositions = [];
            const availablePositions = [];
            for (let i = 0; i < gridSize * gridSize; i++) {
                availablePositions.push(i);
            }
            
            // Shuffle and select positions
            shuffleArray(availablePositions);
            for (let i = 0; i < setSize; i++) {
                currentPositions.push({
                    pos: availablePositions[i],
                    color: COLORS[i % COLORS.length]
                });
            }
            
            // Create grid
            const grid = document.createElement('div');
            grid.className = `grid-container grid-${gridSize}`;
            
            for (let i = 0; i < gridSize * gridSize; i++) {
                const square = document.createElement('div');
                square.className = 'square';
                
                const item = currentPositions.find(p => p.pos === i);
                if (item) {
                    square.style.backgroundColor = item.color;
                } else {
                    square.style.backgroundColor = '#E8E8E8';
                }
                
                grid.appendChild(square);
            }
            
            area.innerHTML = '';
            area.appendChild(grid);
        }

        function showTestStimulus(setSize) {
            const area = document.getElementById('stimulusArea');
            const gridSize = Math.ceil(Math.sqrt(setSize)) + 1;
            
            // Decide if target is present (50% chance)
            targetPresent = Math.random() < 0.5;
            
            let testPos, testColor;
            
            if (targetPresent) {
                // Select a position that was shown
                const item = currentPositions[Math.floor(Math.random() * currentPositions.length)];
                testPos = item.pos;
                testColor = item.color;
            } else {
                // Select a position that wasn't shown OR wrong color
                if (Math.random() < 0.5 && currentPositions.length < gridSize * gridSize) {
                    // Wrong position
                    const usedPositions = currentPositions.map(p => p.pos);
                    const availablePositions = [];
                    for (let i = 0; i < gridSize * gridSize; i++) {
                        if (!usedPositions.includes(i)) {
                            availablePositions.push(i);
                        }
                    }
                    testPos = availablePositions[Math.floor(Math.random() * availablePositions.length)];
                    testColor = COLORS[Math.floor(Math.random() * COLORS.length)];
                } else {
                    // Same position, wrong color
                    const item = currentPositions[Math.floor(Math.random() * currentPositions.length)];
                    testPos = item.pos;
                    const otherColors = COLORS.filter(c => c !== item.color);
                    testColor = otherColors[Math.floor(Math.random() * otherColors.length)];
                }
            }
            
            // Create grid
            const grid = document.createElement('div');
            grid.className = `grid-container grid-${gridSize}`;
            
            for (let i = 0; i < gridSize * gridSize; i++) {
                const square = document.createElement('div');
                square.className = 'square';
                
                if (i === testPos) {
                    square.style.backgroundColor = testColor;
                    square.style.border = '5px solid #333';
                } else {
                    square.style.backgroundColor = '#E8E8E8';
                }
                
                grid.appendChild(square);
            }
            
            area.innerHTML = '';
            area.appendChild(grid);
            
            // Add response buttons
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'response-buttons';
            buttonDiv.innerHTML = `
                <button class="btn-yes" onclick="recordResponse(true)">YES</button>
                <button class="btn-no" onclick="recordResponse(false)">NO</button>
            `;
            area.appendChild(buttonDiv);
            
            trialStartTime = Date.now();
        }

        function recordResponse(response) {
            currentResponse = response;
            
            // Remove YES/NO buttons
            const area = document.getElementById('stimulusArea');
            const buttonDiv = area.querySelector('.response-buttons');
            if (buttonDiv) {
                buttonDiv.remove();
            }
            
            // Show confidence rating scale
            const confidenceDiv = document.createElement('div');
            confidenceDiv.className = 'confidence-scale';
            confidenceDiv.innerHTML = `
                <h3>How confident are you in your response?</h3>
                <div class="confidence-buttons">
                    <button onclick="recordConfidence(1)">1</button>
                    <button onclick="recordConfidence(2)">2</button>
                    <button onclick="recordConfidence(3)">3</button>
                    <button onclick="recordConfidence(4)">4</button>
                    <button onclick="recordConfidence(5)">5</button>
                </div>
                <div class="confidence-label">
                    <span>Not Confident</span>
                    <span>Very Confident</span>
                </div>
            `;
            area.appendChild(confidenceDiv);
        }

        function recordConfidence(confidence) {
            const rt = Date.now() - trialStartTime;
            const correct = (currentResponse === targetPresent);
            
            trialResults.push({
                set: currentSet + 1,
                setSize: SETS[currentSet],
                trial: currentTrial + 1,
                targetPresent: targetPresent ? 1 : 0,
                response: currentResponse ? 1 : 0,
                correct: correct ? 1 : 0,
                confidence: confidence,
                rt: rt
            });
            
            // Move to next trial
            currentTrial++;
            
            if (currentTrial >= TRIALS_PER_SET) {
                currentTrial = 0;
                currentSet++;
                
                if (currentSet >= SETS.length) {
                    // Experiment complete
                    finishExperiment();
                    return;
                }
            }
            
            // Continue with next trial
            runTrial();
        }

        function finishExperiment() {
            showPage('thankYouPage');
        }

        function calculateSDT(results) {
            let hits = 0, misses = 0, fas = 0, crs = 0;
            
            results.forEach(r => {
                if (r.targetPresent === 1 && r.response === 1) hits++;
                else if (r.targetPresent === 1 && r.response === 0) misses++;
                else if (r.targetPresent === 0 && r.response === 1) fas++;
                else if (r.targetPresent === 0 && r.response === 0) crs++;
            });
            
            // Calculate hit and false alarm rates with correction for 0 and 1
            const hitRate = (hits + 0.5) / (hits + misses + 1);
            const faRate = (fas + 0.5) / (fas + crs + 1);
            
            // Calculate d' (sensitivity)
            const zHit = inverseNormal(hitRate);
            const zFA = inverseNormal(faRate);
            const dPrime = zHit - zFA;
            
            // Calculate criterion (c)
            const criterion = -0.5 * (zHit + zFA);
            
            // Calculate bias (beta)
            const bias = Math.exp(criterion * dPrime);
            
            return {
                hits, misses, fas, crs,
                hitRate: hitRate.toFixed(3),
                faRate: faRate.toFixed(3),
                dPrime: dPrime.toFixed(3),
                criterion: criterion.toFixed(3),
                bias: bias.toFixed(3)
            };
        }

        function inverseNormal(p) {
            // Approximation of inverse normal CDF
            const a1 = -3.969683028665376e+01;
            const a2 = 2.209460984245205e+02;
            const a3 = -2.759285104469687e+02;
            const a4 = 1.383577518672690e+02;
            const a5 = -3.066479806614716e+01;
            const a6 = 2.506628277459239e+00;
            
            const b1 = -5.447609879822406e+01;
            const b2 = 1.615858368580409e+02;
            const b3 = -1.556989798598866e+02;
            const b4 = 6.680131188771972e+01;
            const b5 = -1.328068155288572e+01;
            
            const c1 = -7.784894002430293e-03;
            const c2 = -3.223964580411365e-01;
            const c3 = -2.400758277161838e+00;
            const c4 = -2.549732539343734e+00;
            const c5 = 4.374664141464968e+00;
            const c6 = 2.938163982698783e+00;
            
            const d1 = 7.784695709041462e-03;
            const d2 = 3.224671290700398e-01;
            const d3 = 2.445134137142996e+00;
            const d4 = 3.754408661907416e+00;
            
            const pLow = 0.02425;
            const pHigh = 1 - pLow;
            
            if (p < pLow) {
                const q = Math.sqrt(-2 * Math.log(p));
                return (((((c1*q+c2)*q+c3)*q+c4)*q+c5)*q+c6) / ((((d1*q+d2)*q+d3)*q+d4)*q+1);
            } else if (p <= pHigh) {
                const q = p - 0.5;
                const r = q * q;
                return (((((a1*r+a2)*r+a3)*r+a4)*r+a5)*r+a6)*q / (((((b1*r+b2)*r+b3)*r+b4)*r+b5)*r+1);
            } else {
                const q = Math.sqrt(-2 * Math.log(1 - p));
                return -(((((c1*q+c2)*q+c3)*q+c4)*q+c5)*q+c6) / ((((d1*q+d2)*q+d3)*q+d4)*q+1);
            }
        }

        function downloadResults() {
            let csv = 'Participant ID,' + participantData.id + '\n';
            csv += 'Age,' + participantData.age + '\n';
            csv += '\nTrial Data\n';
            csv += 'Set,SetSize,Trial,TargetPresent,Response,Correct,Confidence,RT\n';
            
            trialResults.forEach(r => {
                csv += `${r.set},${r.setSize},${r.trial},${r.targetPresent},${r.response},${r.correct},${r.confidence},${r.rt}\n`;
            });
            
            // Calculate overall SDT
            const overallSDT = calculateSDT(trialResults);
            csv += '\nOverall Signal Detection Theory Analysis\n';
            csv += `Hits,${overallSDT.hits}\n`;
            csv += `Misses,${overallSDT.misses}\n`;
            csv += `False Alarms,${overallSDT.fas}\n`;
            csv += `Correct Rejections,${overallSDT.crs}\n`;
            csv += `Hit Rate,${overallSDT.hitRate}\n`;
            csv += `False Alarm Rate,${overallSDT.faRate}\n`;
            csv += `d' (Sensitivity),${overallSDT.dPrime}\n`;
            csv += `Criterion (c),${overallSDT.criterion}\n`;
            csv += `Bias (beta),${overallSDT.bias}\n`;
            
            // Calculate SDT for each set
            csv += '\nSignal Detection Theory by Set\n';
            csv += 'Set,SetSize,Hits,Misses,FalseAlarms,CorrectRejections,HitRate,FARate,dPrime,Criterion,Bias\n';
            
            for (let i = 0; i < SETS.length; i++) {
                const setResults = trialResults.filter(r => r.set === i + 1);
                const sdt = calculateSDT(setResults);
                csv += `${i+1},${SETS[i]},${sdt.hits},${sdt.misses},${sdt.fas},${sdt.crs},${sdt.hitRate},${sdt.faRate},${sdt.dPrime},${sdt.criterion},${sdt.bias}\n`;
            }
            
            // ROC data
            csv += '\nROC Curve Data\n';
            csv += 'Set,SetSize,FalseAlarmRate,HitRate\n';
            for (let i = 0; i < SETS.length; i++) {
                const setResults = trialResults.filter(r => r.set === i + 1);
                const sdt = calculateSDT(setResults);
                csv += `${i+1},${SETS[i]},${sdt.faRate},${sdt.hitRate}\n`;
            }
            
            // Confidence analysis
            csv += '\nConfidence Analysis\n';
            csv += 'Set,SetSize,AvgConfidence,AvgConfidence_Correct,AvgConfidence_Incorrect\n';
            for (let i = 0; i < SETS.length; i++) {
                const setResults = trialResults.filter(r => r.set === i + 1);
                const avgConf = (setResults.reduce((sum, r) => sum + r.confidence, 0) / setResults.length).toFixed(2);
                const correctResults = setResults.filter(r => r.correct === 1);
                const incorrectResults = setResults.filter(r => r.correct === 0);
                const avgConfCorrect = correctResults.length > 0 ? 
                    (correctResults.reduce((sum, r) => sum + r.confidence, 0) / correctResults.length).toFixed(2) : 'N/A';
                const avgConfIncorrect = incorrectResults.length > 0 ? 
                    (incorrectResults.reduce((sum, r) => sum + r.confidence, 0) / incorrectResults.length).toFixed(2) : 'N/A';
                csv += `${i+1},${SETS[i]},${avgConf},${avgConfCorrect},${avgConfIncorrect}\n`;
            }
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `working_memory_${participantData.id}_${Date.now()}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    </script>
</body>
</html>

